# SCsub — módulo MySQL para Godot (ajuste mínimo p/ corrotinas e Asio sem exceptions)

Import('env')
import os
from os.path import join as PJ
from SCons.Action import Action

mod = env.Clone()

platform = str(mod['platform'])
arch     = str(mod.get('arch', ''))
bits     = int(mod.get('bits', 64 if arch.endswith('64') else 32))

MOD_ROOT        = '.'
TOOLS_PATH      = [PJ(MOD_ROOT, 'tools')]
THIRDPARTY_BASE = PJ(MOD_ROOT, 'thirdparty')
ARCH_STR        = arch if arch else ('x86_64' if bits == 64 else 'x86')
OUTBIN_BASE     = PJ('thirdparty', 'bin', platform, ARCH_STR)

# Tools (Boost/OpenSSL)
mod.Tool('boost',   toolpath=TOOLS_PATH)
mod.Tool('openssl', toolpath=TOOLS_PATH)

boost_info = mod.BoostInstall(
    thirdparty_base='thirdparty',
    outbin_base=OUTBIN_BASE,
    platform=platform,
    bits=bits,
)

openssl_info = mod.OpenSSLStatic(
    thirdparty_base='thirdparty',
    outbin_base=OUTBIN_BASE,
    platform=platform,
    arch=arch,
    bits=bits,
    prefer_mingw=bool(mod.get('use_mingw', False)),
)

# Include/Libs
mod.Prepend(CPPPATH = boost_info['include_dirs'] + openssl_info['include_dirs'])
mod.Prepend(LIBPATH = openssl_info['lib_dirs'])
mod.Prepend(LIBS    = openssl_info['libs'])

if platform == 'linuxbsd':
    mod.Prepend(LIBS=['dl', 'pthread'])
elif platform == 'windows':
    mod.Prepend(LIBS=['ws2_32', 'bcrypt', 'advapi32', 'crypt32'])

# ---- Correções cruciais ----
# 1) Asio sem exceptions (mantém -fno-exceptions do Godot sem tocar em BOOST_NO_EXCEPTIONS)
env.Append(CPPDEFINES=['BOOST_ASIO_NO_EXCEPTIONS', 'ASIO_NO_EXCEPTIONS'])

# 2) Corrotinas C++20 (precisa estar PRESENTE na linha de comando final; por isso usamos 'env')
#    A última opção de -std vence; isso habilita awaitable/co_spawn.
env.Append(CCFLAGS=['-std=gnu++20'])

# Gerar o "separate compilation" do Boost.MySQL
GENERATED_DIR = PJ(MOD_ROOT, 'generated')
GENERATED_SRC = PJ(GENERATED_DIR, 'boost_mysql_separate.cpp')

def _write_boost_mysql_separate(target, source, env):
    os.makedirs(GENERATED_DIR, exist_ok=True)
    content = (
        "// Gerado automaticamente.\n"
        "#define BOOST_ASIO_NO_EXCEPTIONS 1\n"
        "#define ASIO_NO_EXCEPTIONS 1\n"
        "#define BOOST_MYSQL_SEPARATE_COMPILATION\n"
        "#include <boost/mysql/src.hpp>\n"
    )
    with open(str(target[0]), 'w', encoding='utf-8') as f:
        f.write(content)
    return 0

gen_node = mod.Command(
    target=GENERATED_SRC,
    source=[],
    action=Action(_write_boost_mysql_separate, cmdstr='[gen] $TARGET')
)
mod.Clean(gen_node, GENERATED_SRC)
mod.Clean(gen_node, GENERATED_DIR)

# Sources
sources = []
sources += Glob(PJ(MOD_ROOT, 'src', '*.cpp'))
sources.append(gen_node[0])

mod.Prepend(CPPPATH=[PJ(MOD_ROOT, 'src')])
mod.add_source_files(env.modules_sources, sources)
